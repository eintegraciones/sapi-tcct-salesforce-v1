<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:cloudhub="http://www.mulesoft.org/schema/mule/cloudhub" xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/cloudhub http://www.mulesoft.org/schema/mule/cloudhub/current/mule-cloudhub.xsd">
	<sub-flow name="subflow-salesforce-idfile-get" doc:id="5f0ab502-bf06-4e82-977a-8ebac636038d" >
		<json-logger:logger doc:name="START FLOW DOWNLOAD FILE" doc:id="d58ac516-8d4e-4d45-9603-731ba4d940db" config-ref="JSON_Logger_Config" message="#['START FLOW DOWNLOAD FILE ' ++ attributes.uriParams.'id-file' default '']" />
		<set-variable value="#[attributes.uriParams.'id-file']" doc:name="id-file" doc:id="2cf641f8-ac9d-4a2a-b361-9d161f953981" variableName="id-file"/>
		<json-logger:logger doc:name="FLOW ID FILE" doc:id="1ac77903-1ee3-4e56-8c7f-82702f53caa9" config-ref="JSON_Logger_Config" message="#['FLOW ID FILE' ++ (vars.&quot;id-file&quot; default '')]" priority="DEBUG"/>
		<try doc:name="Try" doc:id="31860173-8538-4ead-8e08-4c11a4616332" >
			<salesforce:query doc:name="Query_download_file" doc:id="f35e0dc3-6591-474c-ba15-2eff3f6c17f9" config-ref="Salesforce_Config" readTimeout="300" readTimeoutUnit="SECONDS">
				<reconnect frequency="5000" count="3" />
				<salesforce:salesforce-query><![CDATA[SELECT FileExtension,Title,VersionData FROM ContentVersion WHERE ContentDocumentId = ':ID_DOCUMENT']]></salesforce:salesforce-query>
			<salesforce:parameters><![CDATA[#[output application/java
---
{
	ID_DOCUMENT : vars."id-file"
}]]]></salesforce:parameters>
		</salesforce:query>
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="24920560-220b-43e5-a6a7-81daad8603fc" when='error.cause.message contains "invalid ID field"'>
					<ee:transform doc:name="Transform Message" doc:id="4b805e71-8c60-4113-a341-30b407ec0972" >
						<ee:message >
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
[{VersionData:null}]]]></ee:set-payload>
						</ee:message>
					</ee:transform>
				</on-error-continue>
			</error-handler>
		</try>
		<choice doc:name="Choice" doc:id="e9725626-574e-49a2-a79a-c76b1e9390d2" >
			<when expression="#[payload[0].VersionData != null]">
				<ee:transform doc:name="Transform Message" doc:id="06339c7f-8d7e-43ee-8e0c-a491d330c126">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "fileName": payload[0].Title default '',
  "fileExtension": payload[0].FileExtension default '',
  "bytes": payload[0].VersionData default '',
  "type-bytes": "base64"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="Transform Message" doc:id="7f3b533a-464c-4d4a-8c6c-120a15b7e3f4" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "fileName": 'id file no existe',
  "fileExtension": 'id file no existe',
  "bytes": '',
  "type-bytes": "id file no existe"
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
		<json-logger:logger doc:name="END FLOW DOWNLOAD FILE" doc:id="ff92cc38-3721-4903-814a-bd99a9c7e0a3" config-ref="JSON_Logger_Config" message="END FLOW DOWNLOAD FILE" tracePoint="END" />
	</sub-flow>
</mule>
